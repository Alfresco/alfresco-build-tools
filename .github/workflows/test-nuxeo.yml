name: Test actions Nuxeo ðŸŸ¦

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    paths:
      - '.github/actions/nuxeo/**'
      - '.github/workflows/test-nuxeo.yml'
  pull_request_review:
    types: [ submitted ]

jobs:
  nos-publish:
    if: >-
      (github.event.review.state == 'approved' && contains(fromJSON('["dependabot[bot]", "github-actions[bot]"]'), github.event.pull_request.user.login)) ||
      (github.actor != 'dependabot[bot]' && github.event_name != 'pull_request_review')
    runs-on: ubuntu-latest
    env:
      ZIP_PACKAGE_NAME: dummy.zip
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build zip package file ðŸ“¦
        run: zip ${{ env.ZIP_PACKAGE_NAME }} package.xml install.xml
        working-directory: .github/actions/nuxeo/nos-publish

      - name: Publish Nuxeo Package to NOS staging Connect ðŸ«¸
        id: publish_nos
        uses: ./.github/actions/nuxeo/nos-publish
        with:
          package-path: .github/actions/nuxeo/nos-publish/${{ env.ZIP_PACKAGE_NAME }}
          nos-username: ${{ secrets.NOS_CONNECT_USER }}
          nos-token: ${{ secrets.NOS_CONNECT_TOKEN }}
          nos-env: staging
          nos-org: nuxeo-devops

      - name: Unpublish Module ðŸ«¥
        if: always() && steps.publish_nos.outcome != 'skipped'
        env:
          PACKAGE_URL: ${{ steps.publish_nos.outputs.package-url }}
        run: |
          RESPONSE=$(curl \
            -w "%{http_code}" \
            -su "${{ secrets.NOS_CONNECT_USER }}:${{ secrets.NOS_CONNECT_TOKEN }}" \
            "${PACKAGE_URL//\?//delete?}")
          if [ "$RESPONSE" != "303" ]; then
            echo "ðŸ§Ÿ Failed to unpublish package from NOS Connect. Response code: $RESPONSE"
            exit 1
          fi

  nuxeo-docker-build:
    if: >-
      (github.event.review.state == 'approved' && contains(fromJSON('["dependabot[bot]", "github-actions[bot]"]'), github.event.pull_request.user.login)) ||
      (github.actor != 'dependabot[bot]' && github.event_name != 'pull_request_review')
    runs-on: ubuntu-latest
    env:
      NUXEO_CONNECT_MODULE: nuxeo-web-ui
      NUXEO_LOCAL_MODULE_PACKAGE: nuxeo-ai-image-quality-package
      NUXEO_LOCAL_MODULE: nuxeo-ai-image-quality
      NUXEO_LOCAL_MODULES_PATH: addons
      NUXEO_OS_PACKAGES: |
        awscli
        ccextractor-nuxeo
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Prepare addons directory
        run: mkdir -p ${{ env.NUXEO_LOCAL_MODULES_PATH }}

      - name: Fetch Nuxeo local module
        env:
          PKG_URL: https://packages.nuxeo.com/repository/maven-public-releases/org/nuxeo/ai/${{ env.NUXEO_LOCAL_MODULE_PACKAGE }}/4.0.2/${{ env.NUXEO_LOCAL_MODULE_PACKAGE }}-4.0.2.zip
          NEXUS_USER: ${{ secrets.NUXEO_NEXUS_USER }}
          NEXUS_TOKEN: ${{ secrets.NUXEO_NEXUS_PASSWORD }}
        run: |
          curl -fsSL -u "$NEXUS_USER:$NEXUS_TOKEN" "$PKG_URL" -o ${{ env.NUXEO_LOCAL_MODULES_PATH }}/${{ env.NUXEO_LOCAL_MODULE_PACKAGE }}-4.0.2.zip;
          test -s ${{ env.NUXEO_LOCAL_MODULES_PATH }}/${{ env.NUXEO_LOCAL_MODULE_PACKAGE }}-4.0.2.zip

      - name: Build nuxeo image and push to registry
        uses: ./.github/actions/nuxeo/nuxeo-docker-build
        id: build_nuxeo_image
        with:
          base-registry-username: ${{ secrets.NUXEO_NEXUS_USER }}
          base-registry-password: ${{ secrets.NUXEO_NEXUS_PASSWORD }}
          nuxeo-connect-modules: ${{ env.NUXEO_CONNECT_MODULE }}
          nuxeo-clid: ${{ secrets.NUXEO_CLID }}
          nuxeo-local-modules-path: ${{ env.NUXEO_LOCAL_MODULES_PATH }}
          os-packages: ${{ env.NUXEO_OS_PACKAGES }}
          os-packages-user: ${{ secrets.NUXEO_NEXUS_USER }}
          os-packages-token: ${{ secrets.NUXEO_NEXUS_PASSWORD }}
          image-name: nuxeo/nuxeo-ci-builder-test
          image-tag: ${{ github.run_id }}
          image-title: "Nuxeo CI Builder Test"
          load-image: "true"
          platforms: linux/amd64 # load can only be done for a single platform
          registry: localhost

      - name: Verify installed Nuxeo Modules
        env:
          IMAGE_URL: ${{ steps.build_nuxeo_image.outputs.image-url }}
          EXPECTED_MODULES: ${{ env.NUXEO_CONNECT_MODULE }} ${{ env.NUXEO_LOCAL_MODULE }}
          EXPECTED_PACKAGES: ${{ env.NUXEO_OS_PACKAGES }}
        run: .github/actions/nuxeo/nuxeo-docker-build/verify.sh
