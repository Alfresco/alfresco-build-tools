name: "Terraform"

on:
  workflow_call:
    inputs:
      terraform_root_path:
        description: the path to the root module to apply
        type: string
        required: false
        default: .
      terraform_operation:
        description: |
          the terraform operation to perform (plan, apply or destroy).
          If not set, the operation will be determined based on the GitHub event.
          For pull requests, it will run plan and for pushes it will run apply based on the PR plan.
          For pull requests comments, it will run apply if the comment contains 'terraform apply'.
        type: string
        required: false
      terraform_env:
        description: the terraform environment to use (e.g. dev, staging, prod)
        type: string
        required: false
      create_oidc_token_file:
        description: whether to create a file with an OIDC token for AWS
        type: boolean
        required: false
        default: false
      install_kubectl:
        description: whether to install the kubectl CLI
        type: boolean
        required: false
        default: false
      kubectl_version:
        description: the version of kubectl to install (if install_kubectl is true). If not set, the latest stable version will be installed.
        type: string
        required: false
      tfvars_subfolder:
        description: the subfolder where tfvars files are located (relative to terraform_root_path)
        type: string
        required: false
        default: ''
    secrets:
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      BOT_GITHUB_TOKEN:
        required: false
      DOCKER_USERNAME:
        required: false
      DOCKER_PASSWORD:
        required: false
      RANCHER2_ACCESS_KEY:
        required: false
      RANCHER2_SECRET_KEY:
        required: false

jobs:
  compute_basic_vars:
    name: compute basic variables
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        env:
          TERRAFORM_OPERATION: ${{ inputs.terraform_operation }}
          TFVARS_SUBFOLDER: ${{ inputs.tfvars_subfolder }}
        run: |
          if [ -z "${TERRAFORM_OPERATION}" ]; then
            echo "terraform_operation is not set, defaulting to github event based handling."
          else
            case "${TERRAFORM_OPERATION}" in
              apply|destroy|plan)
                ;;
              *)
                echo "Invalid terraform_operation: ${TERRAFORM_OPERATION}. Must be 'apply', 'destroy', or 'plan'."
                exit 1
                ;;
            esac
          fi

          if [ -z "${TFVARS_SUBFOLDER}" ]; then
            echo "::warning::tfvars_subfolder input is not set. Consider organizing your tfvars files in a 'vars' subfolder for better structure. Set tfvars_subfolder: 'vars' in your workflow to use this recommended layout."
          fi

      - name: Evaluate branch name
        id: basic_vars
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ inputs.terraform_env }}" ]; then
            echo "Using environment from input: ${{ inputs.terraform_env }}"
            echo "environment_name=${{ inputs.terraform_env }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BRANCH_NAME=${{ github.base_ref || github.ref_name }}
          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            echo "Evaluating branch name for issue_comment event"
            BRANCH_NAME=$(gh pr view ${{ github.event.issue.pull_request.html_url }} --json baseRefName --jq '.baseRefName' 2>/dev/null)
          fi

          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            echo "Evaluating branch name for pull_request_review event"
            BRANCH_NAME=$(gh pr view ${{ github.event.pull_request.html_url }} --json baseRefName --jq '.baseRefName' 2>/dev/null)
          fi

          BRANCH_LOWER=${BRANCH_NAME,,}
          if [ "$BRANCH_LOWER" == "main" ]; then
            environment="production"
          elif [[ "$BRANCH_LOWER" =~ ^[a-z][a-z0-9-]{3,}$ ]]; then
            environment="${BRANCH_LOWER}"
          else
            echo "$BRANCH_LOWER is not a valid environment name."
            echo "It must:"
            echo " - start with a letter"
            echo " - contain only lowercase chars, numbers, and hyphens"
            echo " - be at least 4 characters long"
            exit 1
          fi

          echo "environment_name=${environment}" >> "$GITHUB_OUTPUT"

      - name: Add summary info
        env:
          COMMENT_CONTAINS_TERRAFORM_PLAN: ${{ contains(github.event.comment.body, 'terraform plan') || false }}
          COMMENT_CONTAINS_TERRAFORM_APPLY: ${{ contains(github.event.comment.body, 'terraform apply') || false }}
        run: |
          echo "### Running Terraform ðŸš€" >> "$GITHUB_STEP_SUMMARY"
          echo "- Environment: **${{ steps.basic_vars.outputs.environment_name }}**" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ env.COMMENT_CONTAINS_TERRAFORM_PLAN }}" == "true" ]; then
            echo "- Operation: **plan**" >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ env.COMMENT_CONTAINS_TERRAFORM_APPLY }}" == "true" ]; then
            echo "- Operation: **apply**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Operation: **${{ inputs.terraform_operation || ((github.event_name == 'pull_request' || github.event_name == 'pull_request_review') && 'plan' || 'apply') }}**" >> "$GITHUB_STEP_SUMMARY"
          fi
    outputs:
      environment_name: ${{ steps.basic_vars.outputs.environment_name }}

  terraform:
    runs-on: ubuntu-latest
    needs:
      - compute_basic_vars
    environment: ${{ needs.compute_basic_vars.outputs.environment_name }}
    concurrency:
      group: ${{ needs.compute_basic_vars.outputs.environment_name }}
      cancel-in-progress: false
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RANCHER2_ACCESS_KEY: ${{ secrets.RANCHER2_ACCESS_KEY }}
      RANCHER2_SECRET_KEY: ${{ secrets.RANCHER2_SECRET_KEY }}
      RESOURCE_NAME: ${{ vars.RESOURCE_NAME }}
      TF_VAR_resource_name: ${{ vars.RESOURCE_NAME }}
      TERRAFORM_HTTP_CREDENTIALS: |
        github.com/Alfresco=alfresco-build:${{ secrets.BOT_GITHUB_TOKEN }}
      TERRAFORM_PRE_RUN: |
        set +x -euo pipefail
        if [ ! -x ./aws/install ]; then
          curl -sSf https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip
          unzip -q awscliv2.zip
        fi
        ./aws/install
        if [ "${{ inputs.install_kubectl }}" == "true" ]; then
          if [ -z "${{ inputs.kubectl_version }}" ]; then
            echo "âš™ï¸ Will install latest stable kubectl..."
            KUBECTL_VERSION=$(curl -sSfL --max-time 10 --retry 3 https://dl.k8s.io/release/stable.txt)
            echo "âœ… Latest stable kubectl version resolved to ${KUBECTL_VERSION}"
          else
            echo "âš™ï¸ Will install kubectl version ${{ inputs.kubectl_version }}..."
            KUBECTL_VERSION="${{ inputs.kubectl_version }}"
          fi

          echo "ðŸ“¦ Downloading kubectl version ${KUBECTL_VERSION}..."
          curl -sSfL --max-time 30 --retry 3 -o kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          curl -sSfL --max-time 10 --retry 3 -o kubectl.sha256 "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl.sha256"

          echo "ðŸ” Verifying kubectl checksum..."
          if ! echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check --status; then
            echo "âŒ Checksum verification failed for kubectl!"
            exit 1
          fi

          install -m 0755 kubectl /usr/local/bin/kubectl
          rm -f kubectl kubectl.sha256
          echo "âœ… kubectl installed successfully:"
          kubectl version --client
        fi

      # https://github.com/dflook/terraform-github-actions/tree/main/terraform-apply#applying-a-plan-using-a-comment
      PR_CHECKOUT_REF: refs/pull/${{ github.event.issue.number }}/merge
    steps:
      - name: Check environment requirements
        run: |
          if [ -z "${{ vars.RESOURCE_NAME }}" ]; then
            echo "RESOURCE_NAME must be set in the vars context to provide a unique identifier"
            exit 1
          fi
          if [ -z "${{ vars.TERRAFORM_STATE_BUCKET }}" ]; then
            echo "TERRAFORM_STATE_BUCKET must be set in the vars context"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event_name == 'issue_comment' && env.PR_CHECKOUT_REF || '' }}

      - name: Install OIDC Client from Core Package
        if: ${{ inputs.create_oidc_token_file }}
        run: npm install @actions/core@1.11.0 @actions/http-client@2.2.3

      - name: Request token
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        if: ${{ inputs.create_oidc_token_file }}
        id: idtoken
        with:
          script: |
            const coredemo = require('@actions/core')
            let id_token = await coredemo.getIDToken("sts.amazonaws.com")
            coredemo.setOutput('id_token', id_token)

      - name: Save token to file
        if: ${{ inputs.create_oidc_token_file }}
        run: echo "${{ steps.idtoken.outputs.id_token }}" >> idtoken.json

      - name: Assume AWS Role when AWS_ROLE_ARN is set
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        if: vars.AWS_ROLE_ARN != ''
        with:
          aws-region: ${{ env.AWS_DEFAULT_REGION}}
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          role-session-name: TerraformWorkflow

      - name: Load environment variables from yml
        uses: Alfresco/alfresco-build-tools/.github/actions/env-load-from-yaml@v13.0.0
        with:
          yml_path: ${{ inputs.terraform_root_path }}/tfenv.yml

      - name: Terraform validate
        if: (github.event_name == 'pull_request' || github.event_name == 'pull_request_review') && github.run_attempt == 1
        uses: dflook/terraform-validate@4cef5d8a4b92bcd88486e41e22a42942a382c9d6 # v2.2.3
        with:
          path: ${{ inputs.terraform_root_path }}
          backend_config: |
            bucket=${{ vars.TERRAFORM_STATE_BUCKET }}
            key=${{ vars.RESOURCE_NAME }}/${{ inputs.terraform_root_path }}/terraform.tfstate

      - name: Terraform plan
        uses: dflook/terraform-plan@7878bff63e2099cdc9be9a6f33cbbbf687f8f0fe # v2.2.3
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review' || inputs.terraform_operation == 'plan' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'terraform plan'))
        with:
          label: ${{ vars.RESOURCE_NAME }} ${{ inputs.terraform_root_path }}
          path: ${{ inputs.terraform_root_path }}
          var_file: |
            ${{ inputs.terraform_root_path }}/${{ inputs.tfvars_subfolder && format('{0}/', inputs.tfvars_subfolder) || '' }}common.tfvars
            ${{ inputs.terraform_root_path }}/${{ inputs.tfvars_subfolder && format('{0}/', inputs.tfvars_subfolder) || '' }}${{ needs.compute_basic_vars.outputs.environment_name }}.tfvars
          backend_config: |
            bucket=${{ vars.TERRAFORM_STATE_BUCKET }}
            key=${{ vars.RESOURCE_NAME }}/${{ inputs.terraform_root_path }}/terraform.tfstate

      - name: Terraform apply
        uses: dflook/terraform-apply@5489b988934a50bf1489d5b7c5253b46520a7dca # v2.2.3
        if: github.event_name == 'push' || inputs.terraform_operation == 'apply' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'terraform apply'))
        with:
          label: ${{ vars.RESOURCE_NAME }} ${{ inputs.terraform_root_path }}
          path: ${{ inputs.terraform_root_path }}
          auto_approve: ${{ inputs.terraform_operation == 'apply' }}
          var_file: |
            ${{ inputs.terraform_root_path }}/${{ inputs.tfvars_subfolder && format('{0}/', inputs.tfvars_subfolder) || '' }}common.tfvars
            ${{ inputs.terraform_root_path }}/${{ inputs.tfvars_subfolder && format('{0}/', inputs.tfvars_subfolder) || '' }}${{ needs.compute_basic_vars.outputs.environment_name }}.tfvars
          backend_config: |
            bucket=${{ vars.TERRAFORM_STATE_BUCKET }}
            key=${{ vars.RESOURCE_NAME }}/${{ inputs.terraform_root_path }}/terraform.tfstate

      - name: Terraform destroy
        uses: dflook/terraform-destroy@b198834c4a4dd959f26649f2a9d24c59e9c9f205 # v2.2.3
        if: inputs.terraform_operation == 'destroy'
        with:
          path: ${{ inputs.terraform_root_path }}
          var_file: |
            ${{ inputs.terraform_root_path }}/${{ inputs.tfvars_subfolder && format('{0}/', inputs.tfvars_subfolder) || '' }}common.tfvars
            ${{ inputs.terraform_root_path }}/${{ inputs.tfvars_subfolder && format('{0}/', inputs.tfvars_subfolder) || '' }}${{ needs.compute_basic_vars.outputs.environment_name }}.tfvars
          backend_config: |
            bucket=${{ vars.TERRAFORM_STATE_BUCKET }}
            key=${{ vars.RESOURCE_NAME }}/${{ inputs.terraform_root_path }}/terraform.tfstate
