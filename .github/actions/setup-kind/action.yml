name: "Setup a KinD cluster"
description: "Spin a local Kubernetes cluster with latest ingress-nginx"
inputs:
  kind-node-image:
    description: |
      The Kind docker node image to use. Check the Kind version
      release notes to check the list of suitable images:
      https://github.com/kubernetes-sigs/kind/releases
    required: true
    default: kindest/node:v1.24.7@sha256:577c630ce8e509131eab1aea12c022190978dd2f745aac5eb1fe65c0807eb315
  ingress-nginx-ref:
    description: |
      the Nginx ingress ref to get the ingress congtroller deployment manifest from
      (https://github.com/kubernetes/ingress-nginx). Consider main (the default) a floating tag which can result in
      deploying any version (including betas) and non repeatable builds.
    required: false
    default: main
runs:
  using: "composite"
  steps:
    - name: Create cluster
      uses: helm/kind-action@v1.5.0
      with:
        config: ${{ github.action_path }}/kind.yml
        node_image: ${{ inputs.kind-node-image }}

    - name: Install ingress-nginx
      shell: bash
      env:
        NGINX_MANIFEST_URL: >-
          https://raw.githubusercontent.com/kubernetes/ingress-nginx/${{ inputs.ingress-nginx-ref }}/deploy/static/provider/kind/deploy.yaml
      run: |
        kubectl apply -f "${NGINX_MANIFEST_URL}"

    - name: Wait for ingress ready
      shell: bash
      run: |
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=90s
