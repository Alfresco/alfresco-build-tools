name: "Setup a KinD cluster"
description: "Spin a local Kubernetes cluster with ingress-nginx"
inputs:
  kind-version:
    description: |
      The kind version to use. Versions available at:
      https://github.com/kubernetes-sigs/kind/releases
    default: v0.31.0
  kind-node-image:
    description: |
      The Kind docker node image to use. Should match the same kind version at:
      https://github.com/kubernetes-sigs/kind/releases
    default: kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040
  kind-wait:
    description: The duration to wait for the control plane to become ready
    default: 60s
  ingress-nginx-ref:
    description: |
      the Nginx ingress ref to get the ingress controller deployment manifest from
      (https://github.com/kubernetes/ingress-nginx). Consider main (the default) a floating tag which can result in
      deploying any version (including betas) and non repeatable builds.
      Set to "skip" or "none" to NOT install ingress-nginx.
    default: main
  metrics:
    description: Whether Metrics Server should be installed upon cluster creation
    default: "false"
  import-docker-credentials-secret-name:
    description: |
      Whether to create a secret using the given name using file $HOME/.docker/config.json.
      You have to login to one or more registries before using this option.
  ingress-creation-timeout:
    description: |
      The timeout for waiting for the ingress controller to become ready.
      Default is 90 seconds, which should be enough for most cases.
    default: 90s
  kind-config-path:
    description: |
      Path to a custom kind configuration file. If not provided, the action will use the default configuration
      located at `./kind.yml` relative to the action.yml file.
    required: false
runs:
  using: "composite"
  steps:
    - name: Create cluster
      uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0
      with:
        config: ${{ inputs.kind-config-path == '' && format('{0}/kind.yml', github.action_path) || inputs.kind-config-path }}
        version: ${{ inputs.kind-version }}
        node_image: ${{ inputs.kind-node-image }}
        wait: ${{ inputs.kind-wait }}

    - name: Install Metrics Server
      shell: bash
      if: inputs.metrics == 'true'
      run: >-
        helm install --repo https://kubernetes-sigs.github.io/metrics-server/
        --set args={--kubelet-insecure-tls}
        metrics-server metrics-server
        --namespace kube-system

    - name: Install ingress-nginx
      shell: bash
      if: >-
        !contains(fromJson('["skip", "none"]'), inputs.ingress-nginx-ref)
      env:
        NGINX_MANIFEST_URL: >-
          https://raw.githubusercontent.com/kubernetes/ingress-nginx/${{ inputs.ingress-nginx-ref }}/deploy/static/provider/kind/deploy.yaml
      run: |
        kubectl apply -f "${NGINX_MANIFEST_URL}"

    - name: Wait for ingress ready
      shell: bash
      if: >-
        !contains(fromJson('["skip", "none"]'), inputs.ingress-nginx-ref)
      run: |
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=${{ inputs.ingress-creation-timeout }} || {
            echo "Ingress controller failed to become ready. Debugging information:"
            echo "=== Pod Description ==="
            kubectl describe pods -n ingress-nginx -l app.kubernetes.io/component=controller
            echo "=== Pod Logs ==="
            kubectl logs -n ingress-nginx -l app.kubernetes.io/component=controller --tail=100
            exit 1
          }

    - name: Create registries auth secret
      shell: bash
      if: inputs.import-docker-credentials-secret-name != ''
      run: |
        kubectl create secret generic ${{ inputs.import-docker-credentials-secret-name }} \
          --from-file=.dockerconfigjson=$HOME/.docker/config.json \
          --type=kubernetes.io/dockerconfigjson
