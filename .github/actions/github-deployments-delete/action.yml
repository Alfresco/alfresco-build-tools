name: Delete Github Deployments

description: Delete gitHub deployments.Used as workaround to delete the flood of messages added to PRs when we run a workflow with a matrix that have the field environment set in the job.
  In this case a new comment is added in PR for every entry of the matrix.

inputs:
  owner:
    description: The owner of the repository
    required: true
  repo:
    description: The name of the repository
    required: true
  branch-name:
    description: The name of the branch associated with pull request.
    required: true
  environment:
    description: The environment to delete deployments from
    required: false

runs:
  using: composite
  steps:
    - name: delete-deployments
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const perPage = 100;
          let page = 1;
          let allDeployments = [];
          while(true){
          const deployments = await github.rest.repos.listDeployments({
            owner: "${{ inputs.owner }}",
            repo: "${{ inputs.repo }}",
            ref: "${{ inputs.branch-name }}",
            per_page: perPage,
            page: page,
           // Include environment if provided
              ${ inputs.environment ? `environment: "${ inputs.environment }",` : '' }
          });

          allDeployments = [...allDeployments, ...deployments.data];
          if (!deployments.data.length) {
          break;
          }
          page++;
          }

          await Promise.all(
            allDeployments.map(async (deployment) => {
              await github.rest.repos.createDeploymentStatus({
                owner: "${{ inputs.owner }}",
                repo: "${{ inputs.repo }}",
                deployment_id: deployment.id,
                state: 'inactive'
              });
              return github.rest.repos.deleteDeployment({
                owner: "${{ inputs.owner }}",
                repo: "${{ inputs.repo }}",
                deployment_id: deployment.id
              });
            })
            );
