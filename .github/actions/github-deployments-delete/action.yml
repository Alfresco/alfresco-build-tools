name: Delete Github Deployments

description:
  Deletes all GitHub deployments on a given branch.
  Used as workaround to delete the flood of messages visible on some PRs where environments are leveraged but deployments are not.

inputs:
  branch-name:
    description: The name of the branch for the deployments
    required: true
  environment:
    description: The optional environment for the deployments
    required: false

runs:
  using: composite
  steps:
    - name: delete-deployments
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const perPage = 100;
          let page = 1;
          let allDeployments = [];
          while(true){
          const deployments = await github.rest.repos.listDeployments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: "${{ inputs.branch-name }}",
            per_page: perPage,
            page: page,
            environment: "${{ inputs.environment }}"
          });

          allDeployments = [...allDeployments, ...deployments.data];
          if (!deployments.data.length) {
          break;
          }
          page++;
          }

          await Promise.all(
            allDeployments.map(async (deployment) => {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id,
                state: 'inactive'
              });
              return github.rest.repos.deleteDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id
              });
            })
            );
