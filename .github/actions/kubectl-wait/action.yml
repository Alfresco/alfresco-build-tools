---
name: Kubectl wait
description: |
  Wait for all resources inside a namespace to match a given condition.
  Useful for waiting for all pods to be ready before proceeding.
inputs:
  namespace:
    description: Namespace to wait for
    required: false
    default: default
  wait-timeout:
    description: Timeout for the wait command
    required: false
    default: 10m
  wait-for-what:
    description: What to wait for (jsonpath, condition)
    required: false
    default: condition
  wait-condition:
    description: Condition to wait for
    required: false
    default: Ready
  wait-resource:
    description: Resource to wait for
    required: false
    default: pods
runs:
  using: composite
  steps:
    - name: Wait a bit in case of brand new namespace
      shell: bash
      run: |
        timeout 60s bash -c '
        until kubectl get namespace ${{ inputs.namespace }} ; do
          echo "Waiting for namespace ${{ inputs.namespace }} to be created..."
          sleep 2
        done'
        NS_LIFETIME=$(kubectl get namespace ${{ inputs.namespace }} \
            -o jsonpath="{.metadata.creationTimestamp}")
        NOW_SECS=$(date +%s)
        NS_SECS=$(date -d $NS_LIFETIME +%s)
        if [ $((NOW_SECS - NS_SECS)) -lt 10 ]; then
          echo "Namespace ${{ inputs.namespace }} created. Giving other resources some more time to catch up..."
          sleep 10
        fi

    - name: Watch resources
      shell: bash
      run: |
        kubectl get ${{ inputs.wait-resource }} --watch -n ${{ inputs.namespace }} &
        kubectl wait \
          -n ${{ inputs.namespace }} \
          --timeout=${{ inputs.wait-timeout }} \
          --all=true \
          --for=${{ inputs.wait-for-what }}=${{ inputs.wait-condition }} \
          ${{ inputs.wait-resource }}

    - name: Spit resources status after wait
      shell: bash
      if: always()
      run: |
        kubectl get ${{ inputs.wait-resource }} -n ${{ inputs.namespace }}
        kubectl describe ${{ inputs.wait-resource }} -n ${{ inputs.namespace }}
