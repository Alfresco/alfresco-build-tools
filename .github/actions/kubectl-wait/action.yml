---
name: Kubectl wait
description: >
  Wait for all resources inside a namespace to be ready
inputs:
  namespace:
    description: Namespace to wait for
    required: false
    default: default
  wait-timeout:
    description: Timeout for the wait command
    required: false
    default: 10m
  wait-for-what:
    description: What to wait for (jsonpath, condition)
    required: false
    default: condition
  wait-condition:
    description: Condition to wait for
    required: false
    default: Ready
  wait-resource:
    description: Resource to wait for
    required: false
    default: pods
runs:
  using: composite
  steps:
    - name: Wait for namespace for no more than 1 minute
      shell: bash
      run: |
        timeout 60s bash -c '
        until kubectl get namespace ${{ inputs.namespace }} ; do
          echo "Waiting for namespace ${{ inputs.namespace }} to be created..."
          sleep 2
        done'

    - name: Watch resources
      shell: bash
      run: |
        kubectl get ${{ inputs.wait-resource }} --watch ${{ inputs.namespace }} &
        kubectl wait \
          --timeout=${{ inputs.wait-timeout }} \
          --all=true \
          --for=${{ inputs.wait-for-what }}=${{ inputs.wait-condition }} \
          ${{ inputs.wait-resource }} ${{ inputs.namespace }}

    - name: Spit resources status after wait
      shell: bash
      if: always()
      run: |
        kubectl get ${{ inputs.wait-resource }} ${{ inputs.namespace }}
        kubectl describe ${{ inputs.wait-resource }} ${{ inputs.namespace }}
