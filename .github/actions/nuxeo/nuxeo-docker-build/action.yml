name: nuxeo-docker-build
description: Build a customized Nuxeo image (connect modules, local addons, optional OS packages) and push it.
inputs:
  base-image-tag:
    description: Base Nuxeo image tag for docker-private.packages.nuxeo.com/nuxeo/nuxeo (defaults to 2023)
    required: false
    default: "2023"
  base-registry-username:
    description: Username to connect to base image registry
    required: true
  base-registry-password:
    description: Password to connect to base image registry
    required: true
  nuxeo-connect-modules:
    description: Space or comma separated list of Nuxeo Connect marketplace packages to install online
    required: false
    default: ""
  nuxeo-connect-url:
    description: URL of Nuxeo Connect server to use for installing Nuxeo Connect packages
    required: false
    default: ""
  nuxeo-clid:
    description: Nuxeo Connect License ID (CLID) to use for installing Nuxeo Connect packages. Required for nuxeo connect modules.
    required: false
  nuxeo-local-modules-path:
    description: Path (directory) containing offline addon .zip/.jar files to install (relative to repository root)
    required: false
    default: "empty_addons"
  os-packages:
    description: Space separated list of OS packages to install via private yum repo (optional)
    required: false
    default: ""
  os-packages-user:
    description: Username for accessing private yum repo (optional)
    required: false
    default: ""
  os-packages-token:
    description: Token/password for accessing private yum repo (optional)
    required: false
    default: ""
  image-name:
    description: Image name without registry (defaults to <repo>)
    required: false
    default: ""
  image-tag:
    description: Image tag to use (defaults to short sha)
    required: false
    default: ""
  image-title:
    description: Image title label metadata
    required: false
    default: "Nuxeo Server"
  registry:
    description: Target registry (default ghcr.io)
    required: false
    default: ghcr.io
  registry-username:
    description: Username to connect to target registry
    required: false
  registry-password:
    description: Password to connect to target registry
    required: false
  platforms:
    description: Comma separated build platforms
    required: false
    default: linux/amd64,linux/arm64
  push-image:
    description: Whether to push the built image (true/false)
    required: false
    default: "false"
  load-image:
    description: Whether to load the built image into local docker daemon (true/false). When set to true, only a single platform can be specified.
    required: false
    default: "false"
  image-outputs:
    description: List of output destinations. Check https://docs.docker.com/reference/cli/docker/buildx/build/#output
    required: false
    default: ""
  buildx-driver-opts:
    description: Additional buildx driver options
    required: false
    default: ""
  local-registry:
    description: Set to true if you use a local registry. registry-username and registry-password will be ignored.
    required: false
    default: "false"
  image-cache-from:
    description: Cache settings for the image build
    required: false
    default: "type=gha"
  image-cache-to:
    description: Cache settings for the image build
    required: false
    default: "type=gha,mode=max"

outputs:
  image-url:
    description: Fully qualified image reference (registry/image-name:image-tag)
    value: ${{ steps.compute-output.outputs.image_url }}

runs:
  using: composite
  steps:
    - name: Prepare variables
      id: prep
      shell: bash
      run: |
        SHORT_SHA="${GITHUB_SHA:0:12}"
        IMAGE_TAG_INPUT='${{ inputs.image-tag }}'
        IMAGE_TAG=${IMAGE_TAG_INPUT:-$SHORT_SHA}
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        IMAGE_NAME_INPUT='${{ inputs.image-name }}'
        IMAGE_NAME=${IMAGE_NAME_INPUT:-"${REPO_NAME}"}
        BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "FORMATTED_REGISTRY=${{ inputs.registry && format('{0}/', inputs.registry) || '' }}" >> $GITHUB_ENV

    - name: Ensure local nuxeo modules directory exists
      shell: bash
      run: |
        mkdir -p ${{ github.workspace }}/${{ inputs.nuxeo-local-modules-path }}

    - name: Login to base image registry
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: docker-private.packages.nuxeo.com
        username: ${{ inputs.base-registry-username }}
        password: ${{ inputs.base-registry-password }}

    - name: Check if credentials to target registry are provided when pushing image to non-local registry
      if: ${{ inputs.push-image == 'true' && inputs.local-registry == 'false' }}
      shell: bash
      run: |
        if [ -z "${{ inputs.registry-username }}" ] || [ -z "${{ inputs.registry-password }}" ]; then
          echo "Error: registry-username and registry-password inputs are required when push-image is true." >&2
          exit 1
        fi

    - name: Check if CLID is provided when connect modules are specified
      shell: bash
      run: |
        if [ -n "${{ inputs.nuxeo-connect-modules }}" ] && [ -z "${{ inputs.nuxeo-clid }}" ]; then
          echo "Error: nuxeo-clid input is required when nuxeo-connect-modules is provided." >&2
          exit 1
        fi

    - name: Login to target registry
      if: ${{ inputs.push-image == 'true' && inputs.local-registry == 'false' }}
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

    - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
      with:
        driver-opts: ${{ inputs.buildx-driver-opts }}

    - name: Normalize module and package lists
      shell: bash
      run: |
          CONNECT_NORM=$(echo '${{ inputs.nuxeo-connect-modules }}' | tr ',\n\r\t' ' ' | xargs)
          PACKAGES_NORM=$(echo '${{ inputs.os-packages }}' | tr ',\n\r\t' ' ' | xargs)
          echo "SANITIZED_CONNECT_MODULES=$CONNECT_NORM" >> $GITHUB_ENV
          echo "SANITIZED_PACKAGES=$PACKAGES_NORM" >> $GITHUB_ENV

    - name: Build image
      id: build
      uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
      env:
        NUXEO_CLID: ${{ inputs.nuxeo-clid }}
        NUXEO_CONNECT_URL: ${{ inputs.nuxeo-connect-url }}
      with:
        context: ${{ github.action_path }}
        build-contexts: |
          modules=${{ github.workspace }}/${{ inputs.nuxeo-local-modules-path }}
        push: ${{ inputs.push-image }}
        load: ${{ inputs.load-image }}
        platforms: ${{ inputs.platforms }}
        provenance: false
        tags: ${{ env.FORMATTED_REGISTRY }}${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        build-args: |
          BASE_IMAGE_TAG=${{ inputs.base-image-tag }}
          BUILD_TAG=${{ github.run_id }}
          SCM_REF=${{ github.sha }}
          VERSION=${{ env.IMAGE_TAG }}
          BUILD_DATE=${{ env.BUILD_DATE }}
          IMAGE_TITLE=${{ inputs.image-title }}
          NUXEO_CONNECT_MODULES=${{ env.SANITIZED_CONNECT_MODULES }}
          PACKAGES_LIST=${{ env.SANITIZED_PACKAGES }}
          PACKAGES_AUTH_USER=${{ inputs.os-packages-user }}
          PACKAGES_AUTH_TOKEN=${{ inputs.os-packages-token }}
        secret-envs: |
          NUXEO_CLID=NUXEO_CLID
          NUXEO_CONNECT_URL=NUXEO_CONNECT_URL
        secret-files: |
          nuxeo-private=${{ github.action_path }}/nuxeo-private.repo
        outputs: ${{ inputs.image-outputs }}
        cache-from: ${{ inputs.image-cache-from }}
        cache-to: ${{ inputs.image-cache-to }}

    - name: Summary
      shell: bash
      run: |
        echo "### :package: Nuxeo image build" >> $GITHUB_STEP_SUMMARY
        echo "Registry: ${{ env.FORMATTED_REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "Image: ${{ env.FORMATTED_REGISTRY }}${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY

    - name: Compute output image URL
      id: compute-output
      shell: bash
      run: echo "image_url=${{ env.FORMATTED_REGISTRY }}${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
