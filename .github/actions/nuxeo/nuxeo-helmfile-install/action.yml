name: nuxeo-helmfile-install
description: Install Nuxeo Helm charts using Helmfile and port-forward services.
inputs:
  ingress-nginx-ref:
    description: Reference for the ingress-nginx controller
    required: false
    default: "controller-v1.12.1"
  metrics:
    description: Whether to enable metrics for the kind cluster (true/false)
    required: false
    default: "true"
  docker-registry:
    description: Docker registry to pull Nuxeo images from
    required: false
    default: ghcr.io
  docker-registry-username:
    description: Username to connect to the Docker registry
    required: false
    default: ""
  docker-registry-password:
    description: Password to connect to the Docker registry
    required: true
  github-username:
    description: GitHub username to access private Nuxeo Helm charts repository
    required: true
  github-token:
    description: GitHub token to access private Nuxeo Helm charts repository
    required: true
  namespace:
    description: Kubernetes namespace to install Nuxeo charts into
    required: false
    default: default
  helmfile-workdirectory:
    description: Path to the directory containing the Helmfile
    required: true
  helmfile-environment:
    description: Helmfile environment to use
    required: true
  services-label:
    description: Label selector to identify services to port-forward
    required: false
    default: "dev.nuxeo.com/usage=utests"

outputs:
  map:
    description: JSON map of service names to their ports
    value: ${{ steps.services.outputs.map }}

runs:
  using: composite
  steps:
    - name: Setup cluster
      uses: Alfresco/alfresco-build-tools/.github/actions/setup-kind@v12.1.0
      with:
        ingress-nginx-ref: ${{ inputs.ingress-nginx-ref }}
        metrics: ${{ inputs.metrics }}
        kind-config-path: ${{ github.action_path }}/kind.yml

    - name: Login to registry with nuxeo image
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ${{ inputs.docker-registry }}
        username: ${{ inputs.docker-registry-username || github.actor }}
        password: ${{ inputs.docker-registry-password }}

    - name: Install helmfile
      uses: helmfile/helmfile-action@f64d5db9f8660aae0205b5fcfc56577d44acefab # 2.1.0
      env:
        GITHUB_USER: ${{ inputs.github-username }}
        GITHUB_PASSWORD: ${{ inputs.github-token }}
        DOCKER_REGISTRY: ${{ inputs.docker-registry }}
        NAMESPACE: ${{ inputs.namespace }}
      with:
        helmfile-workdirectory: ${{ inputs.helmfile-workdirectory }}
        helmfile-args: apply --environment ${{ inputs.helmfile-environment }}

    - name: Discover test services
      id: services
      shell: bash
      run: |
        SERVICES_JSON=$(kubectl get svc -l ${{ inputs.services-label }} --namespace ${{ inputs.namespace }} -o json | \
          jq -c 'reduce .items[] as $item ({}; . + {($item.metadata.name): $item.spec.ports[0].port})')

        echo "Discovered services: $SERVICES_JSON"
        echo "map=$SERVICES_JSON" >> $GITHUB_OUTPUT

    - name: Port forward services discovered services
      shell: bash
      env:
        SERVICES_MAP: ${{ steps.services.outputs.map }}
      run: |
        for service in $(echo "$SERVICES_MAP" | jq -r 'keys[]'); do
          port=$(echo "$SERVICES_MAP" | jq -r --arg svc "$service" '.[$svc]')
          kubectl port-forward svc/"$service" "$port":"$port" --namespace ${{ inputs.namespace }} &
        done
