name: enforce-pr-conventions

description: Check if the branch name and pull request title follow conventional checks.

inputs:
  jira-project-name:
    description: 'The JIRA project name.'
    required: false
  valid-branch-regex:
    description: 'The regular expression to check the branch name.'
    required: false
  valid-pr-title-regex:
    description: 'The regular expression to check the pull request title.'
    required: false

runs:
  using: composite
  steps:
    - name: Get branch name
      if: github.event_name == 'pull_request'
      uses: Alfresco/alfresco-build-tools/.github/actions/get-branch-name@v5.13.1

    - name: Generate regex
      shell: bash
      if: github.event_name == 'pull_request'
      id: generate-regex
      run: |
        if [[ -z "${{ inputs.valid-branch-regex }}" ]]; then
          echo "valid-branch-regex=^(improvement|bug|feature|test|tmp)/${{ inputs.jira-project-name }}-[0-9]+-[A-Za-z0-9._-]+$" >> $GITHUB_OUTPUT
        else
          echo "valid-branch-regex=${{ inputs.valid-branch-regex }}" >> $GITHUB_OUTPUT
        fi

        if [[ -z "${{ inputs.valid-pr-title-regex }}" ]]; then
          echo "valid-pr-title-regex=^${{ inputs.jira-project-name }}-[0-9]+ .+$" >> $GITHUB_OUTPUT
        else
          echo "valid-pr-title-regex=${{ inputs.valid-pr-title-regex }}" >> $GITHUB_OUTPUT
        fi

    - name: Check branch name
      if: github.event_name == 'pull_request'
      shell: bash
      run: |
        local_branch="${{ env.BRANCH_NAME }}"
        branch_regex="${{ steps.generate-regex.outputs.valid-branch-regex }}"

        message="::error::The branch name doesn't follow the expected conventions: "
        message+="please rename your branch following the regexp $branch_regex, "
        message+="close this pull request, and open a new one."

        if [[ ${#local_branch} != 0 && ! $local_branch =~ $branch_regex ]]; then
          echo "$message"
          exit 1
        fi

    - name : Check Title of Pull Request
      if: github.event_name == 'pull_request'
      shell: bash
      run: |
        pr_title="AAE-123 convetional commits"

        pr_regex="${{ steps.generate-regex.outputs.valid-pr-title-regex }}"

        message="::error::The PR title '$pr_title' doesn't follow the expected conventions: "
        message+="please edit it following the regexp '$pr_regex small description'."

        if [[ ! $pr_title =~ $pr_regex ]]; then
          echo "$message"
          exit 1
        fi
