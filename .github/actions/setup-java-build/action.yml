name: "Setup Java build"
description: "Performs the setup of required build tools (eg.: Maven, Java)"
inputs:
  java-version:
    description: the desired Java version
    default: "17"
    required: false
  java-distribution:
    description: the desired Java distribution
    default: "temurin"
    required: false
  maven-settings:
    description: the location of the custom Maven settings.xml file to install
    default: ".ci.settings.xml"
    required: false
runs:
  using: composite
  steps:
    - name: "Cache local Maven repository"
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: "Install ${{ inputs.maven-settings }}"
      shell: bash
      run: |
        mkdir -p $HOME/.m2
        if [ -f "${{ inputs.maven-settings }}" ]; then
          echo "Installing Maven settings file found in the repository: ${{ inputs.maven-settings }}"
          cp "${{ inputs.maven-settings }}" $HOME/.m2/settings.xml
        else
          echo "Maven settings file: ${{ inputs.maven-settings }} not found in the repository. Installing the default one"
          cp ${{ github.action_path }}/settings.xml $HOME/.m2/settings.xml
        fi

    - name: Enable maven build cache
      shell: bash
      run: |
        mkdir -p .mvn
        cp ${{ github.action_path }}/extensions.xml .mvn/extensions.xml
        cp ${{ github.action_path }}/maven-build-cache-config.xml .mvn/maven-build-cache-config.xml

    - name: "Build cache"
      uses: actions/cache@v3
      with:
        path: ~/.m2/build-cache
        key: ${{ runner.os }}-buildcache-${{ hashFiles('.mvn/*.xml') }}-${{ github.job }}-${{ github.ref_name }}-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-buildcache-${{ hashFiles('.mvn/*.xml') }}-${{ github.job }}-${{ github.ref_name }}-
          ${{ runner.os }}-buildcache-${{ hashFiles('.mvn/*.xml') }}-${{ github.job }}-
          ${{ runner.os }}-buildcache-${{ hashFiles('.mvn/*.xml') }}-
          ${{ runner.os }}-buildcache-

    - name: Install latest mvnd
      uses: sdkman/sdkman-action@b1f9b696c79148b66d3d3a06f7ea801820318d0f
      with:
        candidate: mvnd

    - name: Install latest maven
      uses: sdkman/sdkman-action@b1f9b696c79148b66d3d3a06f7ea801820318d0f
      with:
        candidate: maven

    - name: "Set up Java"
      uses: actions/setup-java@v3
      with:
        java-version: ${{ inputs.java-version }}
        distribution: ${{ inputs.java-distribution }}
        overwrite-settings: false
