name: "Verify and test helm chart"
description: "Setup environment and run helm chart tests"
inputs:
  aws_access_key_id:
    description: ""
    required: true
  aws_secret_access_key:
    description: ""
    required: true
  docker_username:
    description: "username for Docker Hub"
    required: true
  docker_password:
    description: "password for Docker Hub"
    required: true
  quay_username:
    description: "username for Quay.io"
    required: false
  quay_password:
    description: "password for Quay.io"
    required: false
  commit_message:
    description: ""
    required: true
  branch_name:
    description: ""
    required: true
  acm_certificate:
    description: ""
    required: true
  aws_sg:
    description: ""
    required: true
  domain:
    description: ""
    required: false
    default: dev.envalfresco.com
  aws_region:
    description: ""
    required: false
    default: eu-west-1
  kubectl_version:
    description: "version of the kubectl CLI"
    required: false
    default: 'v1.23.6'

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-region: ${{ inputs.aws_region }}
    - uses: azure/setup-kubectl@v2.0
      with:
        version: ${{ inputs.aws_region }}
    - name: Login to Quay.io
      uses: docker/login-action@v1
      with:
        registry: quay.io
        username: ${{ inputs.quay_username }}
        password: ${{ inputs.quay_password }}
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ inputs.docker_username}}
        password: ${{ inputs.docker_password }}
    - name: Set commit message
      run: |
        echo COMMIT_MESSAGE="${{ inputs.commit_message }}" >> $GITHUB_ENV
      shell: bash
    - name: Run helm chart test script
      run: .github/scripts/aps_helm_install.sh
      shell: bash
      env:
        BRANCH_NAME: ${{ inputs.branch_name }}
        ACM_CERTIFICATE: ${{ inputs.acm_certificate }}
        AWS_SG: ${{ inputs.aws_sg }}
