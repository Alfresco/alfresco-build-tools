name: "Verify and test helm chart"
description: "Setup environment and run helm chart tests"
inputs:
  service:
    description: "type of Alfresco service to verfiy - either 'acs' or 'aps'"
    required: true
  acs_version:
    description: "version of ACS to verify"
    required: false
  aws_access_key_id:
    description: "ID of AWS access key"
    required: true
  aws_secret_access_key:
    description: "AWS access key"
    required: true
  docker_username:
    description: "username for Docker Hub"
    required: true
  docker_password:
    description: "password for Docker Hub"
    required: true
  quay_username:
    description: "username for Quay.io"
    required: false
  quay_password:
    description: "password for Quay.io"
    required: false
  branch_name:
    description: "name of branch from which workflow was triggered"
    required: false
  acm_certificate:
    description: "certificate for Amazon Certificate Manager"
    required: true
  aws_sg:
    description: "AWS Security Group"
    required: true
  domain:
    description: "domain to access the cluster"
    required: false
    default: dev.envalfresco.com
  aws_region:
    description: "AWS region to create cluster in"
    required: false
    default: eu-west-1
  kubectl_version:
    description: "version of the kubectl CLI"
    required: false
    default: 'v1.23.6'

runs:
  using: composite
  steps:
    - name: Check service configuration
      if: ${{ inputs.service != 'aps' && inputs.service != 'acs' }}
      run: |
        echo "Service name can be either 'acs' or 'aps' got ${{ inputs.service }}"
        exit 1
      shell: bash
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-region: ${{ inputs.aws_region }}
        aws-access-key-id: ${{ inputs.aws_access_key_id }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
    - uses: azure/setup-kubectl@v2.0
      with:
        version: ${{ inputs.kubectl_version }}
    - name: Login to Quay.io
      uses: docker/login-action@v1
      with:
        registry: quay.io
        username: ${{ inputs.quay_username }}
        password: ${{ inputs.quay_password }}
      if: ${{ inputs.service == 'aps' || inputs.acs_version != 'community' }}
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ inputs.docker_username}}
        password: ${{ inputs.docker_password }}
    - name: Get branch name
      uses: Alfresco/alfresco-build-tools/.github/actions/load-branch-name@OPSEXP-1545-helm-build-actions
    - name: Get commit msg
      run: |
        MSG=$(git log --format=%B -n 1 ${{github.event.after}})
        echo COMMIT_MESSAGE=\"$MSG\" >> $GITHUB_ENV
      shell: bash
    - name: Run helm chart test script
      run: ${{ github.action_path }}/${{ inputs.service }}_helm_install.sh
      shell: bash
      env:
        # BRANCH_NAME: ${{ inputs.branch_name }}
        ACM_CERTIFICATE: ${{ inputs.acm_certificate }}
        AWS_SG: ${{ inputs.aws_sg }}
        DOMAIN: ${{ inputs.domain }}
        ACS_VERSION: ${{ inputs.acs_version }}
