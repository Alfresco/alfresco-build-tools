name: "Free GHA runner disk space"
description: "Frees up disk space on GitHub Actions hosted runners by removing unneeded software and optionally merging disk volumes to maximize build space."
inputs:
  merge-disk-volumes:
    description: 'Triggers usage of maximize-build-space action to take advantage of unused disk space. Disabled by default due to long duration.'
    required: false
    default: 'false'
  root-reserve-mb:
    description: 'Space to be left free on the root filesystem, in Megabytes. Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: '12288'
  temp-reserve-mb:
    description: 'Space to be left free on the temp filesystem (/mnt), in Megabytes. Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: '100'
  swap-size-mb:
    description: 'Swap space to create, in Megabytes. Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: '1024'
  overprovision-lvm:
    description: |
      Create the LVM disk images as sparse files, making the space required for the LVM image files *appear* unused on the
      hosting volumes until actually allocated. Use with care, this can lead to surprising out-of-disk-space situations.
      You should prefer adjusting root-reserve-mb/temp-reserve-mb over using this option.
    required: false
    default: 'false'
  build-mount-path:
    description: 'Absolute path to the mount point where the build space will be available, defaults to /var/lib/docker/ if unset. Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: '/var/lib/docker/'
  build-mount-path-ownership:
    description: 'Ownership of the mount point path, defaults to standard "runner" user and group. Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: 'runner:runner'
  pv-loop-path:
    description: 'Absolute file path for the LVM image created on the root filesystem, the default is usually fine. Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: '/pv.img'
  tmp-pv-loop-path:
    description: 'Absolute file path for the LVM image created on the temp filesystem, the default is usually fine. Must reside on /mnt . Only applicable if merge-disk-volumes is set to true.'
    required: false
    default: '/mnt/tmp-pv.img'
  remove-dotnet:
    description: 'Removes .NET runtime and libraries'
    required: false
    default: 'true'
  remove-haskell:
    description: 'Removes GHC (Haskell) artifacts'
    required: false
    default: 'true'
  remove-tools-cache:
    description: 'Removes tools and dependencies cached'
    required: false
    default: 'true'
  remove-android:
    description: 'Removes Android SDKs and Tools'
    required: false
    default: 'true'
  remove-codeql:
    description: 'Removes CodeQL Action Bundles'
    required: false
    default: 'true'
  remove-swift:
    description: 'Removes Swift toolchain and libraries'
    required: false
    default: 'true'
  remove-docker-images:
    description: 'Removes cached Docker images'
    required: false
    default: 'false'
  remove-paths:
    description: Additional collection of files/folders to be removed, separated by spaces.
    default: ''
    required: false
  diagnose-top-offenders-enabled:
    description: 'Runs a diagnostic step to list top disk space offenders before cleanup.'
    required: false
    default: 'false'

runs:
  using: "composite"
  steps:
    - name: Runner system report before modification
      shell: bash
      run: |
        echo "Memory and swap:"
        sudo free -m
        echo
        sudo swapon --show
        echo

        echo "Available storage:"
        sudo df -h
        echo

    - name: Move /var/lib/docker/
      if: inputs.merge-disk-volumes == 'true'
      run: sudo mv /var/lib/docker/ "${GITHUB_WORKSPACE}/docker"
      shell: bash

    - name: Run optional diagnostic of top offenders before cleanup
      if: inputs.diagnose-top-offenders-enabled == 'true'
      run: |
        sudo du -h --max-depth=4 /usr /opt | sort -hr 2>/dev/null | head -n 20 || true
      shell: bash

    - name: Remove unwanted software
      run: |
        if [[ ${{ inputs.remove-dotnet }} == 'true' ]]; then
          echo "Removing .NET runtime and libraries..."
          du -sh /usr/share/dotnet 2>/dev/null || echo "/usr/share/dotnet not found"
          start_time=$(date +%s)
          sudo rm -rf /usr/share/dotnet
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        if [[ ${{ inputs.remove-android }} == 'true' ]]; then
          echo "Removing Android SDKs and Tools..."
          du -sh /usr/local/lib/android 2>/dev/null || echo "/usr/local/lib/android not found"
          start_time=$(date +%s)
          sudo rm -rf /usr/local/lib/android
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        if [[ ${{ inputs.remove-haskell }} == 'true' ]]; then
          echo "Removing GHC (Haskell) artifacts..."
          du -sh /usr/local/.ghcup 2>/dev/null || echo "/usr/local/.ghcup not found"
          start_time=$(date +%s)
          sudo rm -rf /usr/local/.ghcup
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        if [[ ${{ inputs.remove-codeql }} == 'true' ]]; then
          echo "Removing CodeQL Action Bundles..."
          du -sh /opt/hostedtoolcache/CodeQL 2>/dev/null || echo "/opt/hostedtoolcache/CodeQL not found"
          start_time=$(date +%s)
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        if [[ ${{ inputs.remove-tools-cache }} == 'true' ]]; then
          echo "Removing tools and dependencies cache..."
          du -sh $AGENT_TOOLSDIRECTORY 2>/dev/null || echo "$AGENT_TOOLSDIRECTORY not found"
          start_time=$(date +%s)
          sudo rm -rf $AGENT_TOOLSDIRECTORY/*
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        if [[ ${{ inputs.remove-swift }} == 'true' ]]; then
          echo "Removing Swift toolchain and libraries..."
          du -sh /usr/share/swift 2>/dev/null || echo "/usr/share/swift not found"
          start_time=$(date +%s)
          sudo rm -rf /usr/share/swift
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        if [[ ${{ inputs.remove-docker-images }} == 'true' ]]; then
          echo "Removing cached Docker images..."
          start_time=$(date +%s)
          sudo docker image prune --all --force
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        to_remove="${{ inputs.remove-paths }}"
        if [[ -n "$to_remove" ]]; then
          echo "Removing additional files/folders..."
          du -sh $to_remove 2>/dev/null || echo "$to_remove not found"
          start_time=$(date +%s)
          sudo rm -rf $to_remove
          end_time=$(date +%s)
          echo "Removed in $((end_time - start_time)) seconds"
        fi

        echo "Done removing unwanted software."
      shell: bash

    - name: Run optional diagnostic of top offenders after cleanup
      if: inputs.diagnose-top-offenders-enabled == 'true'
      run: |
        sudo du -h --max-depth=4 /usr /opt | sort -hr 2>/dev/null | head -n 20 || true
      shell: bash

    - name: Maximize build space
      if: inputs.merge-disk-volumes == 'true'
      uses: easimon/maximize-build-space@fc881a613ad2a34aca9c9624518214ebc21dfc0c # v10
      with:
        root-reserve-mb: ${{ inputs.root-reserve-mb }}
        temp-reserve-mb: ${{ inputs.temp-reserve-mb }}
        swap-size-mb: ${{ inputs.swap-size-mb }}
        overprovision-lvm: ${{ inputs.overprovision-lvm }}
        build-mount-path: ${{ inputs.build-mount-path }}
        build-mount-path-ownership: ${{ inputs.build-mount-path-ownership }}
        pv-loop-path: ${{ inputs.pv-loop-path }}
        tmp-pv-loop-path: ${{ inputs.tmp-pv-loop-path }}

    - name: Restore /var/lib/docker/
      if: inputs.merge-disk-volumes == 'true'
      run: sudo sh -c "mv ${GITHUB_WORKSPACE}/docker/* /var/lib/docker"
      shell: bash

    - name: Runner system report after cleanup
      run: |
        echo "Memory and swap:"
        sudo free -m
        echo
        sudo swapon --show
        echo

        echo "Available storage:"
        sudo df -h
      shell: bash
