name: validate-propagation-pr
author: sbhattacharyya
description: Validate commits in propagation PR
runs:
  using: "composite"
  steps:
    - name: Validate commits in propagation PR
      if: |
        github.event.pull_request.user.login == 'Sourav-Bhattacharyya' &&
        contains(toJson(github.event.pull_request.labels.*.name), 'updatebot')
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
        GITHUB_REPOSITORY=$(echo "$GITHUB_REPOSITORY")
        echo "Fetching commits for propagation PR #$PR_NUMBER..."
        # Debug: Show token permissions and repo
        echo "Repository: $GITHUB_REPOSITORY"
        echo "PR Number: $PR_NUMBER"
        echo "GH_TOKEN length: ${#GH_TOKEN}"
        # Try fetching PR details for debug
        gh api repos/"$GITHUB_REPOSITORY"/pulls/"$PR_NUMBER" || {
          echo "❌ Could not fetch PR details. Check permissions or PR existence."; exit 1;
        }
        COMMITS=$(gh api repos/"$GITHUB_REPOSITORY"/pulls/"$PR_NUMBER"/commits --jq '.[]')
        echo "$COMMITS" | jq -c '.' | while read -r commit; do
          gh_author=$(echo "$commit" | jq -r '.author.login')
          commit_author=$(echo "$commit" | jq -r '.commit.author.name')
          parents_count=$(echo "$commit" | jq '.parents | length')
          # 1. Commit from Sourav-Bhattacharyya (GitHub user)
          if [[ "$gh_author" == "Sourav-Bhattacharyya" ]]; then
            echo "✅ Allowed commit from GitHub user Sourav-Bhattacharyya"
            continue
          fi
          # 2. Merge commits (multiple parents)
          if [[ "$parents_count" -gt 1 ]]; then
            echo "✅ Allowed merge commit (multiple parents)"
            continue
          fi
          # 3. Rebase commits (authored by Sourav-Bhattacharyya but committed by another user)
          if [[ "$commit_author" == "Sourav-Bhattacharyya" ]]; then
            echo "✅ Allowed rebase commit (authored by Sourav-Bhattacharyya)"
            continue
          fi
          # 4. Block anything else
          echo "❌ Unauthorized commit by GitHub user '$gh_author' (author: '$commit_author')"
          exit 1
        done
        echo "✅ All commits are valid for propagation PR"
