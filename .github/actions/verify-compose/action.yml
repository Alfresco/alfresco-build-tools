name: "Verify and test docker compose"
description: "Setup environment and run docker compose tests"
inputs:
  acs_version:
    description: "version of ACS to verify"
    required: true
  docker_username:
    description: "username for Docker Hub"
    required: true
  docker_password:
    description: "password for Docker Hub"
    required: true
  quay_username:
    description: "username for Quay.io"
    required: false
  quay_password:
    description: "password for Quay.io"
    required: false
  branch_name:
    description: "name of branch from which workflow was triggered"
    required: true

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - if: ${{ inputs.acs_version != 'community' }}
      name: Login to Quay.io
      uses: docker/login-action@v1
      with:
        registry: quay.io
        username: ${{ inputs.QUAY_USERNAME }}
        password: ${{ inputs.QUAY_PASSWORD }}
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ inputs.DOCKER_USERNAME }}
        password: ${{ inputs.DOCKER_PASSWORD }}
    - name: Get commit msg
      run: |
        MSG=$(git log --format=%B -n 1 ${{github.event.after}})
        echo COMMIT_MESSAGE=\"$MSG\" >> $GITHUB_ENV
      shell: bash
    - name: Run Docker Compose tests
      id: compose
      run: ${{ github.action_path }}/docker_compose.sh
      shell: bash
      env:
        ACS_VERSION: ${{ inputs.acs_version }}
        BRANCH_NAME: ${{ inputs.branch_name }}
