name: Update Deployment Status
description: Update Deployment Status
inputs:
  github-token:
    description: GitHub Token
    required: true
  deployment-id:
    description: The Deployment Id
    required: true
  state:
    description: >
      The Deployment State to be set (error, failure, inactive, in_progress, queued, pending, success)
      If empty, failure-if is used to set the state.
  failure-if:
    description: >
      If the state is empty, this input should indicate whether the failure state should be set.
      Default is success.

runs:
  using: "composite"
  steps:
    - name: Update deployment status
      id: update
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        DEPLOYMENT_ID: ${{ inputs.deployment-id }}
        STATE: ${{ inputs.state }}
        REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        FAILURE_IF: ${{ inputs.failure-if }}
      shell: bash
      run: |
        URL="/repos/$GITHUB_REPOSITORY/deployments/$DEPLOYMENT_ID/statuses"
        LOG_URL="$REPO_URL/actions/runs/$GITHUB_RUN_ID/attempts/$GITHUB_RUN_ATTEMPT"

        if [ -z "$STATE" ]; then
          [[ "$FAILURE_IF" == "true" ]] && STATE='failure' || STATE='success'
        fi

        echo "Updating deployment $DEPLOYMENT_ID with state $STATE"
        UPDATED="$(gh api -X POST $URL -F state=$STATE -F log_url=$LOG_URL)"
        echo $UPDATED

        DEPLOYMENT_URL="$(echo $UPDATED | jq -r ".url")"
        ENVIRONMENT="$(echo $UPDATED | jq -r ".environment")"

        echo "Updated deployment status for [$ENVIRONMENT]($REPO_URL/deployments/$ENVIRONMENT) to: $STATE" >> $GITHUB_STEP_SUMMARY
