name: "Package helm chart"
description: "Package helm chart by running `helm dep up` and ` helmp package`"
inputs:
  chart-dir:
    description: "Relative path to the folder holding Chart.yaml"
    required: true
  chart-repository-dir:
    description: Optional path to the git repository holding the chart project (defaults to current directory)
    required: false
outputs:
  package-file:
    description: The name of the generated package file. It's uploaded as an artifact and can be downloaded using actions/download-artifact
    value: ${{ steps.package.outputs.package-file }}

runs:
  using: composite
  steps:
    - name: Package
      id: package
      shell: bash
      env:
        CHART_REPO_DIR: ${{inputs.chart-repository-dir }}
      run: |
        if [ -n "$CHART_REPO_DIR" ]
        then
          cd $CHART_REPO_DIR
        fi

        helm dep up ${{ inputs.chart-dir }}
        helm package ${{ inputs.chart-dir }}
        PACKAGE_FILE=$(ls | grep *\.tgz)
        PACKAGE_FILE_PATH="$(pwd)/$PACKAGE_FILE"
        echo "::set-output name=package-file::$PACKAGE_FILE"
        echo "::set-output name=package-file-path::$PACKAGE_FILE_PATH"

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{steps.package.outputs.package-file}}
        path: ${{steps.package.outputs.package-file-path}}
        if-no-files-found: error
