name: "PMD"
description: "Run PMD against changes in a pull request"
inputs:
  pmd-version:
    description: The version of PMD to use
    required: false
    default: "6.55.0"
  create-github-annotations:
    description: |
      Whether to create inline comments on the PR using GH Advanced Security. This is free for open source projects but
      requires a license for private repos.
    required: false
    default: "true"
  fail-on-new-issues:
    description: |
      When set to true this fails the build if the PR introduces more issues than it resolves.
    required: false
    default: "true"
  pmd-ruleset-ref:
    description: |
      The git reference (e.g. branch name or commit id) for the Alfresco/pmd-ruleset project.
    required: false
    default: "master"

runs:
  using: "composite"
  steps:
    - name: Clone the full history
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Download ruleset
      uses: actions/checkout@v3
      with:
        repository: AlfrescoLabs/pmd-ruleset
        ref: ${{ inputs.pmd-ruleset-ref }}
        path: pmd-ruleset

    - name: Install PMD
      uses: pmd/pmd-github-action@d57c0463ebba262a33d1983a5c6ac6031bfde43b # v1.4.1
      id: pmd
      with:
        version: ${{ inputs.pmd-version }}
        rulesets: pmd-ruleset/pmd-ruleset.xml
        createGitHubAnnotations: ${{ inputs.create-github-annotations }}

    - name: Run PMD scan against changes
      run: ${{ github.action_path }}/delta-scan.sh "pmd-ruleset/pmd-ruleset.xml" "origin/${{ github.base_ref }}" "origin/${{ github.head_ref }}" "${{ inputs.fail-on-new-issues }}"
      if: ${{ github.event_name == 'pull_request' }}
      shell: bash
      env:
        PMD_VERSION: ${{ inputs.pmd-version }}

    - name: Create a summary of PMD findings
      run: python ${{ github.action_path }}/create-summary.py -o "${{ env.OLD_REPORT_FILE }}" -n "${{ env.NEW_REPORT_FILE }}" -d "${{ env.FULL_DIFF_FILE }}" -t "PMD differences between ${{ env.HEAD_REF }} and ${{ env.BASELINE_REF }}"
      if: ${{ github.event_name == 'pull_request' }}
      shell: bash

    - name: Archive PMD summary
      uses: actions/upload-artifact@v3
      if: ${{ github.event_name == 'pull_request' }}
      with:
        name: pmd-summary
        path: ${{ env.PMD_SUMMARY_FILE }}
